name: CI + CD (backend via OIDC)

on:
  push:
    branches: ["main"]
  pull_request:

permissions:
  id-token: write
  contents: read

# change ces valeurs si besoin
env:
  AZ_RG: dev-bayroumeter-rg
  AZ_FUNCTION_APP: bayroumeter-function-louan

concurrency:
  group: backend-deploy
  cancel-in-progress: true

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - run: npm ci
      - run: npm test

  deploy:
    needs: test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Auth Azure via OIDC (utilise les VARIABLES du repo)
      - uses: azure/login@v2
        with:
          client-id: ${{ vars.AZURE_CLIENT_ID }}
          tenant-id: ${{ vars.AZURE_TENANT_ID }}
          subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}

      # Cr√©e un ZIP propre pour Zip Deploy (pas de node_modules, ni .github, ni local.settings.json)
      - name: Create zip package
        run: |
          zip -r release.zip . \
            -x "node_modules/*" ".git/*" ".github/*" "local.settings.json"

      # Utilise l'Azure CLI officielle pour pousser le zip
      - name: Deploy to Azure Functions (zip)
        uses: azure/cli@v2
        with:
          azcliversion: latest
          inlineScript: |
            az functionapp deployment source config-zip \
              -g "$AZ_RG" \
              -n "$AZ_FUNCTION_APP" \
              --src release.zip
